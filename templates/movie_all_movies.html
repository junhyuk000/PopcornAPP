{% extends 'movie_base.html' %}

{% block content %}
<div class="container">
    <h1 class="mt-4 mb-4 text-center">ğŸ¬ ì˜í™” ë°ì´í„° ì¡°íšŒ</h1>

    <!-- ê²€ìƒ‰ í•„í„° -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label>ì œëª©</label>
            <input type="text" id="title" class="form-control" placeholder="ì˜í™” ì œëª© ì…ë ¥">
        </div>
        <div class="col-md-4">
            <label>ì¥ë¥´</label>
            <select id="genre" class="form-control">
                <option value="">-- ì „ì²´ --</option>
                {% for g in filters.genres %}
                <option value="{{ g }}">{{ g }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label>êµ­ê°€</label>
            <select id="nation" class="form-control">
                <option value="">-- ì „ì²´ --</option>
                {% for n in filters.nations %}
                <option value="{{ n }}">{{ n }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-4">
            <label>ê°ë…</label>
            <input type="text" id="director" class="form-control" placeholder="ê°ë… ì…ë ¥">
        </div>
        <div class="col-md-4">
            <label>ë°°ìš°</label>
            <input type="text" id="actor" class="form-control" placeholder="ë°°ìš° ì…ë ¥">
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="searchMovies()">ğŸ” ê²€ìƒ‰</button>
        </div>
    </div>

    <!-- í…Œì´ë¸” -->
    <table id="movieTable" class="table table-striped">
        <thead>
            <tr>
                <th>ìˆœìœ„</th>
                <th>ì œëª©</th>
                <th>ì¥ë¥´</th>
                <th>êµ­ê°€</th>
                <th>ê°ë…</th>
                <th>ë°°ìš°</th>
                <th>ë§¤ì¶œì•¡</th>
                <th>ê´€ê°ìˆ˜</th>
            </tr>
        </thead>
        <tbody id="movieData"></tbody>
    </table>
</div>

<!-- AJAX -->
<script>
    function searchMovies() {
        let query = `?title=${document.getElementById("title").value}&genre=${document.getElementById("genre").value}&nation=${document.getElementById("nation").value}&director=${document.getElementById("director").value}&actor=${document.getElementById("actor").value}`;
        fetch(`/filter${query}`)
            .then(response => response.json())
            .then(data => updateTable(data));
    }
    // í…Œì´ë¸” ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateTable(data) {
        const tbody = document.getElementById('movieData');
        tbody.innerHTML = '';  // ê¸°ì¡´ ë°ì´í„° ì´ˆê¸°í™”

        if (Array.isArray(data)) {
            data.forEach(movie => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${movie.rank}</td>
                    <td>${movie.movie_title}</td>
                    <td>${movie.genre || '-'}</td>
                    <td>${movie.nations || '-'}</td>
                    <td>${movie.director || '-'}</td>
                    <td>${movie.actors || '-'}</td>
                    <td>${formatNumber(movie.total_sales)}</td>
                    <td>${formatNumber(movie.total_audience)}</td>
                `;
                tbody.appendChild(row);
            });
        } else if (data.message) {
            // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ëŠ” ê²½ìš°
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">${data.message}</td>
                </tr>
            `;
        }
    }

    // ìˆ«ì í¬ë§·íŒ… í•¨ìˆ˜
    function formatNumber(num) {
        if (!num) return '-';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë°ì´í„° ë¡œë”©
    document.addEventListener('DOMContentLoaded', function() {
        searchMovies();  // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ë°ì´í„° ë¡œë”©
    });

    // ì •ë ¬ ê¸°ëŠ¥ ì¶”ê°€
    function sortMovies(orderBy) {
        let query = `?order_by=${orderBy}&title=${document.getElementById("title").value}&genre=${document.getElementById("genre").value}&nation=${document.getElementById("nation").value}&director=${document.getElementById("director").value}&actor=${document.getElementById("actor").value}`;
        fetch(`/filter${query}`)
            .then(response => response.json())
            .then(data => updateTable(data));
    }
</script>

{% endblock %}
