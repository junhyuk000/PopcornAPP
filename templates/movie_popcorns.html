{% extends 'movie_base.html' %}

{% block content %}
<h2 style="color: white;">🎬 영화 리스트</h2>
<div class="movie-container">
    {% for movie in movies %}
    <div class="movie-card">
        <img src="{{ url_for('static', filename='images/' + movie.filename) }}" alt="{{ movie.title }}">
        <h3 style="color: white;">{{ movie.title }}</h3>
        <p style="color: wheat;">🎬 감독: {{ movie.director }}</p>
        <p style="color: wheat;">⭐ 평점: {{ movie.rating if movie.rating else 'N/A' }}</p>
        <p style="color: wheat;">💬 리뷰: {{ movie.reviews if movie.reviews else 0 }}개</p>
        <p style="color: wheat;">
            🍿 관객수: 
            <span class="audience" title="{{ movie.c_audience }}">
                {{ (movie.c_audience // 10000) | string + '만명' if movie.c_audience >= 10000 else movie.c_audience|string + '명' }}
            </span>
        </p>
        <button class="lottery-btn" onclick="confirmLottery({{ movie.id }}, '{{ movie.title }}')">추첨하기</button>
    </div>
    {% endfor %}
</div>

<script>
    function confirmLottery(movie_id, movie_title) {
        let userConfirm = confirm("추첨을 하시겠습니까?");
        if (userConfirm) {
            submitLottery(movie_id, movie_title);
        }
    }

    function submitLottery(movie_id, movie_title) {
        fetch("/movie_popcorns", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ movie_id: movie_id, movie_title: movie_title })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);  // 팝콘 부족 등 오류 메시지 표시
            } else {
                alert(data.message);  // 정상적으로 추첨되었을 경우 메시지 표시
                location.reload();  // 페이지 새로고침
            }
        })
        .catch(error => console.error("Error:", error));
    }
</script>

<style>
    .movie-container { display: flex; flex-wrap: wrap; gap: 20px; }
    .movie-card { width: 200px; padding: 10px; border: 1px solid #ddd; text-align: center; }
    .movie-card img { width: 100%; height: 250px; object-fit: cover; }
    .lottery-btn { padding: 5px 10px; background-color: #ff9800; color: white; border: none; cursor: pointer; }
    .audience { cursor: pointer; border-bottom: 1px dashed wheat; }
</style>
{% endblock %}
