{% extends 'movie_base.html' %}

{% block content %}
<div class="container">
    <h1 class="mt-4 mb-4 text-center">ğŸ¬ ì˜í™” ë°ì´í„° ì¡°íšŒ</h1>

    <!-- ê²€ìƒ‰ì°½ -->
    <div class="input-group mb-3">
        <input type="text" id="searchQuery" class="form-control" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥ (êµ­ê°€, ê°ë…, ë°°ìš°)">
        <button class="btn btn-primary" onclick="searchMovies()">ğŸ” ê²€ìƒ‰</button>
    </div>

    <!-- ì •ë ¬ ë²„íŠ¼ -->
    <div class="text-center mb-3">
        <button class="btn btn-outline-primary" onclick="loadMovies('total_audience')">ğŸ“Š ëˆ„ì  ê´€ëŒê° ìˆœ</button>
        <button class="btn btn-outline-secondary" onclick="loadMovies('total_sales')">ğŸ’° ëˆ„ì  ë§¤ì¶œì•¡ ìˆœ</button>
    </div>

    <!-- ì˜í™” ë°ì´í„° í…Œì´ë¸” -->
    <table id="movieTable" class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>ìˆœìœ„</th>
                <th>ì˜í™” ì œëª©</th>
                <th>ì¥ë¥´</th>
                <th>êµ­ê°€</th>
                <th>ê°ë…</th>
                <th>ë°°ìš°</th>
                <th>ëˆ„ì  ë§¤ì¶œì•¡</th>
                <th>ëˆ„ì  ê´€ëŒê°</th>
            </tr>
        </thead>
        <tbody id="movieData">
            {% for row in data %}
            <tr>
                <td>{{ row.rank }}</td>
                <td>{{ row.movie_title }}</td>
                <td>{{ row.genre }}</td>
                <td>{{ row.nations }}</td>
                <td>{{ row.director }}</td>
                <td>{{ row.actors }}</td>
                <td>{{ "{:,}".format(row.total_sales) }} ì›</td>
                <td>{{ "{:,}".format(row.total_audience) }} ëª…</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- ê²€ìƒ‰ ê²°ê³¼ ì—†ì„ ë•Œ ë©”ì‹œì§€ -->
    <div id="noResultsMessage" class="alert alert-danger text-center" style="display: none;">
        âŒ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
    </div>
</div>

<!-- AJAXë¥¼ í™œìš©í•œ ì •ë ¬ & ê²€ìƒ‰ ê¸°ëŠ¥ -->
<script>
    function loadMovies(orderBy) {
        let searchQuery = document.getElementById("searchQuery").value.trim();
        fetch(`/filter?order_by=${orderBy}&search=${searchQuery}`)
            .then(response => response.json())
            .then(data => updateTable(data));
    }

    function searchMovies() {
        let searchQuery = document.getElementById("searchQuery").value.trim();
        fetch(`/filter?search=${searchQuery}`)
            .then(response => response.json())
            .then(data => updateTable(data));
    }

    function updateTable(data) {
        let tableBody = document.getElementById("movieData");
        let noResultsMessage = document.getElementById("noResultsMessage");

        if (data.message) {
            tableBody.innerHTML = "";  // í…Œì´ë¸” ë‚´ìš© ì´ˆê¸°í™”
            noResultsMessage.style.display = "block";  // "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ" ë©”ì‹œì§€ í‘œì‹œ
            return;
        }

        noResultsMessage.style.display = "none";  // "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ" ë©”ì‹œì§€ ìˆ¨ê¹€
        tableBody.innerHTML = "";  // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ

        data.forEach(row => {
            let tr = `<tr>
                <td>${row.rank}</td>
                <td>${row.movie_title}</td>
                <td>${row.genre}</td>
                <td>${row.nations}</td>
                <td>${row.director}</td>
                <td>${row.actors}</td>
                <td>${row.total_sales.toLocaleString()} ì›</td>
                <td>${row.total_audience.toLocaleString()} ëª…</td>
            </tr>`;
            tableBody.innerHTML += tr;
        });
    }
</script>

{% endblock %}
