{% extends 'movie_base.html' %}
{% block css %}
<style>
    table td {
        white-space: nowrap;  /* 줄바꿈 방지 */
        overflow: hidden;  /* 넘치는 텍스트 숨김 */
        text-overflow: ellipsis;  /* 너무 긴 경우 ... 처리 */
        max-width: 200px;  /* 셀의 최대 너비 설정 */
    }
</style>
{% endblock %}

{% block content %}
<h2 class="mt-4 mb-4 text-center">🎬 영화 데이터 조회</h2>
<div class="container">
    <!-- 정렬 버튼 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="btn-group" role="group" aria-label="정렬 기준">
                <button id="sort-total_audience" class="btn btn-primary sort-btn" onclick="changeOrderBy('total_audience')">
                    👥 관람객 순
                </button>
                <button id="sort-total_sales" class="btn btn-outline-primary sort-btn" onclick="changeOrderBy('total_sales')">
                    💰 매출액 순
                </button>
            </div>
        </div>
    </div>

    <!-- 검색 필터 -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label>제목</label>
            <input type="text" id="title" class="form-control" placeholder="영화 제목 입력">
        </div>
        <div class="col-md-4">
            <label>장르</label>
            <select id="genre" class="form-control">
                <option value="">-- 전체 --</option>
                {% for g in filters.genres %}
                <option value="{{ g }}">{{ g }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label>국가</label>
            <select id="nation" class="form-control">
                <option value="">-- 전체 --</option>
                {% for n in filters.nations %}
                <option value="{{ n }}">{{ n }}</option>
                {% endfor %}
            </select>
        </div>
    </div>


<!-- 기존 검색 필터들... -->
    <div class="row mb-3">
        <div class="col-md-4">
            <label>감독</label>
            <input type="text" id="director" class="form-control" placeholder="감독 입력">
        </div>
        <div class="col-md-4">
            <label>배우</label>
            <input type="text" id="actor" class="form-control" placeholder="배우 입력">
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100" onclick="searchMovies()">🔍 검색</button>
        </div>
    </div>

    <!-- 테이블 -->
    <table id="movieTable" class="table table-striped">
        <thead>
            <tr>
                <th>순위</th>
                <th>제목</th>
                <th>장르</th>
                <th>국가</th>
                <th>감독</th>
                <th>배우</th>
                <th>매출액</th>
                <th>관객수</th>
            </tr>
        </thead>
        <tbody id="movieData"></tbody>
    </table>
    <!-- 페이지네이션 컨테이너 추가 -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-center">
                <div id="pagination" class="btn-group" role="group"></div>
            </div>
        </div>
    </div>
</div>

<!-- AJAX -->
<script>
    function searchMovies() {
        let query = `?title=${document.getElementById("title").value}&genre=${document.getElementById("genre").value}&nation=${document.getElementById("nation").value}&director=${document.getElementById("director").value}&actor=${document.getElementById("actor").value}`;
        fetch(`/filter${query}`)
            .then(response => response.json())
            .then(data => updateTable(data));
    }
    let currentPage = 1;
    let currentOrderBy = 'total_audience';  // 기본 정렬 기준

    function updateTable(data) {
        const tbody = document.getElementById('movieData');
        tbody.innerHTML = '';  // 기존 데이터 초기화

        if (data.data && data.data.length > 0) {
            data.data.forEach(movie => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="no-wrap">${movie.rank}</td>
                    <td class="no-wrap">${movie.movie_title}</td>
                    <td class="no-wrap">${movie.genre || '-'}</td>
                    <td class="no-wrap">${movie.nations || '-'}</td>
                    <td class="no-wrap">${movie.director || '-'}</td>
                    <td class="no-wrap">${movie.actors || '-'}</td>
                    <td class="no-wrap">${formatNumber(movie.total_sales)}</td>
                    <td class="no-wrap">${formatNumber(movie.total_audience)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // 페이지네이션 업데이트
            updatePagination(data.pages);
        } else {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">검색 결과가 없습니다.</td>
                </tr>
            `;
            document.getElementById('pagination').innerHTML = '';
        }
    }

    function updatePagination(totalPages) {
        const pagination = document.getElementById('pagination');
        let paginationHtml = '';
        
        // 처음 페이지로 이동
        paginationHtml += `
            <button class="btn btn-secondary me-2" 
                    onclick="changePage(1)"
                    ${currentPage === 1 ? 'disabled' : ''}>
                ≪
            </button>
        `;
        
        // 이전 페이지 버튼
        paginationHtml += `
            <button class="btn btn-secondary me-2" 
                    onclick="changePage(${currentPage - 1})"
                    ${currentPage === 1 ? 'disabled' : ''}>
                ＜
            </button>
        `;
        
        // 페이지 번호들 (현재 페이지 주변 5개만 표시)
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, currentPage + 2);
        
        if (startPage > 1) {
            paginationHtml += '<span class="mx-2">...</span>';
        }
        
        for (let i = startPage; i <= endPage; i++) {
            if (i === currentPage) {
                paginationHtml += `
                    <button class="btn btn-primary mx-1">${i}</button>
                `;
            } else {
                paginationHtml += `
                    <button class="btn btn-outline-primary mx-1" 
                            onclick="changePage(${i})">
                        ${i}
                    </button>
                `;
            }
        }
        
        if (endPage < totalPages) {
            paginationHtml += '<span class="mx-2">...</span>';
        }
        
        // 다음 페이지 버튼
        paginationHtml += `
            <button class="btn btn-secondary ms-2" 
                    onclick="changePage(${currentPage + 1})"
                    ${currentPage === totalPages ? 'disabled' : ''}>
                ＞
            </button>
        `;
        
        // 마지막 페이지로 이동
        paginationHtml += `
            <button class="btn btn-secondary ms-2" 
                    onclick="changePage(${totalPages})"
                    ${currentPage === totalPages ? 'disabled' : ''}>
                ≫
            </button>
        `;
        
        pagination.innerHTML = paginationHtml;
    }

    function changePage(page) {
        currentPage = page;
        searchMovies();
    }

    function changeOrderBy(orderBy) {
        currentOrderBy = orderBy;
        currentPage = 1;  // 정렬 기준이 바뀌면 첫 페이지로 이동
        searchMovies();
        
        // 정렬 버튼 활성화 상태 업데이트
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-outline-primary');
        });
        document.getElementById(`sort-${orderBy}`).classList.remove('btn-outline-primary');
        document.getElementById(`sort-${orderBy}`).classList.add('btn-primary');
    }

    function searchMovies() {
        let query = `?page=${currentPage}&order_by=${currentOrderBy}&title=${document.getElementById("title").value}&genre=${document.getElementById("genre").value}&nation=${document.getElementById("nation").value}&director=${document.getElementById("director").value}&actor=${document.getElementById("actor").value}`;
        fetch(`/filter${query}`)
            .then(response => response.json())
            .then(data => updateTable(data));
    }

    // 페이지 로드 시 초기 데이터 로딩
    document.addEventListener('DOMContentLoaded', function() {
        currentPage = 1;
        searchMovies();
    });

    function formatNumber(num) {
        if (!num) return '-';
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
</script>

{% endblock %}
