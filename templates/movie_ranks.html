{% extends "movie_base.html" %}
{% block css %}
<style>
    .button-container {
        display: flex;
        flex-wrap: wrap; /* ë²„íŠ¼ì´ í™”ë©´ì— ë§ê²Œ ì¤„ë°”ê¿ˆ */
        justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
        gap: 10px; /* ë²„íŠ¼ ê°„ê²© ì¡°ì • */
        margin-top: 20px;
        margin-bottom: 200px;
    }

    .button-container .btn {
        min-width: 120px; /* ë²„íŠ¼ ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
        padding: 10px 15px; /* ë²„íŠ¼ ì—¬ë°± ì„¤ì • */
        font-size: 14px; /* ë²„íŠ¼ ê¸€ê¼´ í¬ê¸° ì¤„ì´ê¸° */
    }
</style>

{% endblock %}
{% block content %}
<div class="text-center">
    <h1 class="mb-4" style="color: white;">Audience & Revenue Trends</h1>
    <div class="row">
        <!-- ì°¨íŠ¸ ì˜ì—­ -->
        <div class="col-md-8">
            <canvas id="chart" style="max-width: 100%; height: 60vh;"></canvas>
        </div>

        <!-- ë§¤ì¶œì•¡ ìˆœìœ„ -->
        <div class="col-md-4">
            <h3 style="color: white;" id="rank-title">ì¼ì¼ ê´€ê°ìˆ˜</h3>
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th style="color: white;">Rank</th>
                        <th style="color: white;">Title</th>
                    </tr>
                </thead>
                <tbody id="ranking-table-body">
                    <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ë°ì´í„° ì¶”ê°€ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- ì°¨íŠ¸ ì „í™˜ ë²„íŠ¼ -->
    <div class="d-flex flex-wrap justify-content-center mt-4 gap-2">
        <button class="btn btn-outline-light mx-2" onclick="updateChartAndRank('t_audience')">ì¼ì¼ ê´€ê°ìˆ˜</button>
        <button class="btn btn-outline-light mx-2" onclick="updateChartAndRank('c_audience')">ëˆ„ì  ê´€ê°ìˆ˜</button>
        <button class="btn btn-outline-light mx-2" onclick="updateChartAndRank('t_sales')">ì¼ì¼ ë§¤ì¶œì•¡</button>
        <button class="btn btn-outline-light mx-2" onclick="updateChartAndRank('c_sales')">ëˆ„ì  ë§¤ì¶œì•¡</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-3d"></script>

<script>
    // í…œí”Œë¦¿ì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const moviesData = JSON.parse('{{ movies_data | tojson | safe }}');

    const dataSets = {
        t_sales: moviesData.map(movie => movie.t_sales),
        c_sales: moviesData.map(movie => movie.c_sales),
        t_audience: moviesData.map(movie => movie.t_audience),
        c_audience: moviesData.map(movie => movie.c_audience),
    };
    const movieNames = moviesData.map(movie => movie.title);

    let currentMetric = 't_audience';

    // ë§‰ëŒ€ ìƒ‰ìƒì„ ì œëª©ë³„ë¡œ ë‹¤ë¥´ê²Œ ì„¤ì •
    const barColors = movieNames.map((_, index) => {
        const colors = [
            'rgba(255, 99, 132, 0.8)',  // ë¹¨ê°„ìƒ‰
            'rgba(54, 162, 235, 0.8)', // íŒŒë€ìƒ‰
            'rgba(255, 206, 86, 0.8)', // ë…¸ë€ìƒ‰
            'rgba(75, 192, 192, 0.8)', // ì´ˆë¡ìƒ‰
            'rgba(153, 102, 255, 0.8)', // ë³´ë¼ìƒ‰
            'rgba(255, 159, 64, 0.8)',  // ì£¼í™©ìƒ‰
            'rgba(99, 255, 132, 0.8)',  // ì—°ì´ˆë¡ìƒ‰
        ];
        return colors[index % colors.length]; // ìƒ‰ìƒ ë°°ì—´ì„ ë°˜ë³µì ìœ¼ë¡œ í• ë‹¹
    });

    // 3D ì°¨íŠ¸ ì´ˆê¸°í™”
    const ctx = document.getElementById('chart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar3d',  // 3D ë§‰ëŒ€ ì°¨íŠ¸ ì ìš©
        data: {
            labels: movieNames,
            datasets: [{
                label: 'ì¼ì¼ ê´€ê°ìˆ˜',
                data: dataSets[currentMetric],
                backgroundColor: barColors,
                borderColor: barColors.map(color => color.replace('0.8','1')),
                borderWidth: 1
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'ì¼ì¼ ê´€ê°ìˆ˜',
                    color: 'white',
                    font: { size: 20 }
                }
            },
            scales: {
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                }
            },
            responsive: true,
            maintainAspectRatio: false,

            // ğŸ”¥ 3D ì°¨íŠ¸ ì„¤ì • ì¶”ê°€
            bar3d: {
                depth: 15, // 3D ê¹Šì´ (ê°’ì´ í´ìˆ˜ë¡ ê¹Šì–´ì§)
                viewAngleX: 10, // Xì¶• ê¸°ìš¸ê¸°
                viewAngleY: 20, // Yì¶• ê¸°ìš¸ê¸°
                zOffset: 5  // ë§‰ëŒ€ ì‚¬ì´ì˜ ê°„ê²©
            }
        }
    });

    // ì°¨íŠ¸ ë° ìˆœìœ„ ì—…ë°ì´íŠ¸
    function updateChartAndRank(metric) {
        currentMetric = metric;
        chart.data.datasets[0].data = dataSets[metric];
        chart.data.datasets[0].label = getLabel(metric);
        chart.options.plugins.title.text = getLabel(metric);
        chart.update();
        updateRanking(metric);
        document.getElementById('rank-title').textContent = `${getLabel(metric)}`;
    }

    function updateRanking(metric) {
        const rankingTableBody = document.getElementById('ranking-table-body');
        rankingTableBody.innerHTML = '';
        const sortedMovies = [...moviesData].sort((a, b) => b[metric] - a[metric]);

        sortedMovies.forEach((movie, index) => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td style="color: white;">${index + 1}</td>
                <td style="color: white; white-space: nowrap;">${movie.title}</td>
            `;
            rankingTableBody.appendChild(row);
        });
    }

    function getLabel(metric) {
        switch (metric) {
            case 't_audience': return 'ì¼ì¼ ê´€ê°ìˆ˜';
            case 'c_audience': return 'ëˆ„ì  ê´€ê°ìˆ˜';
            case 't_sales': return 'ì¼ì¼ ë§¤ì¶œì•¡';
            case 'c_sales': return 'ëˆ„ì  ë§¤ì¶œì•¡';
            default: return '';
        }
    }

    updateRanking(currentMetric);
</script>
{% endblock %}
